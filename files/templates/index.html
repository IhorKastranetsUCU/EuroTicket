<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EuroTicket â€” Railway Explorer</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --orange: #E8722A;
    --orange-light: #F4A261;
    --orange-dim: rgba(232, 114, 42, 0.18);
    --bg: #111111;
    --bg2: #191919;
    --bg3: #222222;
    --border: rgba(255,255,255,0.07);
    --text: #F0EDE8;
    --text-dim: #888;
    --panel-w: 380px;
    --transition: 0.25s cubic-bezier(0.4,0,0.2,1);
  }

  html, body {
    height: 100%;
    font-family: 'Syne', sans-serif;
    background: var(--bg);
    color: var(--text);
    overflow: hidden;
  }

  /* â”€â”€ MAP â”€â”€ */
  #map {
    position: fixed;
    inset: 0;
    z-index: 0;
    filter: contrast(1.05) brightness(0.97);
  }

  .leaflet-tile-pane { filter: grayscale(1) brightness(0.38) sepia(0.15); }
  .leaflet-control-zoom { display: none; }
  .leaflet-attribution-flag { display: none !important; }
  .leaflet-control-attribution {
    background: rgba(0,0,0,0.5) !important;
    color: #444 !important;
    font-size: 9px !important;
  }

  /* â”€â”€ SIDEBAR â”€â”€ */
  #sidebar {
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    width: var(--panel-w);
    background: rgba(14,13,12,0.92);
    backdrop-filter: blur(24px) saturate(1.4);
    border-right: 1px solid var(--border);
    z-index: 100;
    display: flex;
    flex-direction: column;
    transform: translateX(calc(-1 * var(--panel-w)));
    transition: transform 0.4s cubic-bezier(0.4,0,0.2,1);
  }

  #sidebar.open { transform: translateX(0); }

  .sidebar-header {
    padding: 28px 28px 20px;
    border-bottom: 1px solid var(--border);
  }

  .sidebar-label {
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.2em;
    color: var(--orange);
    text-transform: uppercase;
    margin-bottom: 6px;
  }

  .sidebar-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--text);
    line-height: 1.4;
  }

  .route-count {
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    color: var(--text-dim);
    margin-top: 4px;
  }

  #routes-list {
    flex: 1;
    overflow-y: auto;
    padding: 16px 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  #routes-list::-webkit-scrollbar { width: 4px; }
  #routes-list::-webkit-scrollbar-track { background: transparent; }
  #routes-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .route-card {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 18px;
    transition: border-color var(--transition), transform var(--transition);
    animation: slideIn 0.3s ease both;
  }

  .route-card:hover {
    border-color: var(--orange-dim);
    transform: translateX(4px);
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(12px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .route-card-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 12px;
  }

  .train-number {
    font-family: 'DM Mono', monospace;
    font-size: 20px;
    font-weight: 500;
    color: var(--orange);
    line-height: 1;
  }

  .train-name {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 3px;
    font-weight: 400;
  }

  .amenities {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    justify-content: flex-end;
  }

  .amenity {
    width: 28px;
    height: 28px;
    border-radius: 8px;
    background: var(--bg2);
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    title: attr(title);
    transition: background var(--transition), border-color var(--transition);
  }

  .amenity.active {
    background: var(--orange-dim);
    border-color: rgba(232,114,42,0.35);
  }

  .route-stops {
    display: flex;
    flex-direction: column;
    gap: 0;
    position: relative;
  }

  .stop-row {
    display: flex;
    align-items: stretch;
    gap: 10px;
  }

  .stop-timeline {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 16px;
    flex-shrink: 0;
  }

  .stop-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: var(--orange);
    border: 1.5px solid var(--bg3);
    flex-shrink: 0;
    margin-top: 3px;
  }

  .stop-row:first-child .stop-dot,
  .stop-row:last-child .stop-dot {
    width: 9px;
    height: 9px;
    background: var(--orange-light);
  }

  .stop-line {
    flex: 1;
    width: 1.5px;
    background: rgba(232,114,42,0.25);
    min-height: 12px;
  }

  .stop-content {
    flex: 1;
    padding-bottom: 10px;
  }

  .stop-station {
    font-size: 12px;
    font-weight: 600;
    color: var(--text);
    line-height: 1.3;
  }

  .stop-times {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--text-dim);
    margin-top: 2px;
  }

  /* â”€â”€ SEARCH BAR â”€â”€ */
  #search-bar {
    position: fixed;
    bottom: 32px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 200;
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(20,19,18,0.88);
    backdrop-filter: blur(20px) saturate(1.5);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 50px;
    padding: 8px 8px 8px 16px;
    box-shadow: 0 8px 40px rgba(0,0,0,0.6), 0 0 0 1px rgba(232,114,42,0.08);
    transition: box-shadow var(--transition), border-color var(--transition);
    min-width: 380px;
  }

  #search-bar:focus-within {
    border-color: rgba(232,114,42,0.3);
    box-shadow: 0 8px 40px rgba(0,0,0,0.7), 0 0 0 1px rgba(232,114,42,0.15);
  }

  .search-field {
    flex: 1;
    position: relative;
  }

  .search-field label {
    display: block;
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--orange);
    margin-bottom: 2px;
  }

  .search-field input {
    width: 100%;
    background: none;
    border: none;
    outline: none;
    font-family: 'Syne', sans-serif;
    font-size: 14px;
    font-weight: 500;
    color: var(--text);
    caret-color: var(--orange);
  }

  .search-field input::placeholder { color: var(--text-dim); font-weight: 400; }

  .swap-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--bg3);
    border: 1px solid var(--border);
    color: var(--text-dim);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all var(--transition);
    flex-shrink: 0;
    font-size: 16px;
  }

  .swap-btn:hover { background: var(--orange-dim); border-color: var(--orange); color: var(--orange); transform: rotate(180deg); }

  .divider-v {
    width: 1px;
    height: 28px;
    background: var(--border);
    flex-shrink: 0;
  }

  /* â”€â”€ AUTOCOMPLETE â”€â”€ */
  .autocomplete-dropdown {
    position: absolute;
    bottom: calc(100% + 10px);
    left: 0;
    right: 0;
    background: rgba(20,19,18,0.97);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border);
    border-radius: 14px;
    overflow: hidden;
    max-height: 200px;
    overflow-y: auto;
    z-index: 300;
    display: none;
    box-shadow: 0 -4px 30px rgba(0,0,0,0.5);
  }

  .autocomplete-dropdown.show { display: block; }

  .autocomplete-item {
    padding: 10px 14px;
    font-size: 13px;
    color: var(--text);
    cursor: pointer;
    transition: background var(--transition);
    border-bottom: 1px solid var(--border);
  }

  .autocomplete-item:last-child { border-bottom: none; }
  .autocomplete-item:hover, .autocomplete-item.selected { background: var(--orange-dim); color: var(--orange-light); }

  /* â”€â”€ LOGO â”€â”€ */
  #logo {
    position: fixed;
    top: 24px;
    left: 24px;
    z-index: 200;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .logo-icon {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    background: var(--orange);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
  }

  .logo-text {
    font-size: 16px;
    font-weight: 800;
    letter-spacing: -0.01em;
    color: var(--text);
  }

  .logo-text span { color: var(--orange); }

  /* â”€â”€ STATUS â”€â”€ */
  #status-hint {
    position: fixed;
    top: 24px;
    right: 24px;
    z-index: 200;
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 0.08em;
    color: var(--text-dim);
    background: rgba(14,13,12,0.7);
    backdrop-filter: blur(10px);
    padding: 8px 14px;
    border-radius: 50px;
    border: 1px solid var(--border);
    transition: all var(--transition);
  }

  /* â”€â”€ CUSTOM MARKERS via CSS â”€â”€ */
  .station-label {
    font-family: 'Syne', sans-serif;
    font-size: 11px;
    font-weight: 600;
    color: rgba(240,237,232,0.75);
    background: none;
    border: none;
    white-space: nowrap;
    pointer-events: none;
    text-shadow: 0 1px 3px rgba(0,0,0,0.9), 0 0 6px rgba(0,0,0,0.8);
  }

  /* â”€â”€ CLEAR BTN â”€â”€ */
  #clear-btn {
    position: fixed;
    bottom: 94px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 200;
    background: rgba(20,19,18,0.88);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border);
    color: var(--text-dim);
    font-family: 'Syne', sans-serif;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 7px 18px;
    border-radius: 50px;
    cursor: pointer;
    transition: all var(--transition);
    display: none;
  }

  #clear-btn:hover { background: rgba(232,114,42,0.15); border-color: var(--orange); color: var(--orange); }
  #clear-btn.visible { display: block; }

  /* â”€â”€ LOADING â”€â”€ */
  #loading {
    position: fixed;
    inset: 0;
    background: var(--bg);
    z-index: 999;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 20px;
    transition: opacity 0.5s ease;
  }

  #loading.fade-out { opacity: 0; pointer-events: none; }

  .loader-logo { font-size: 32px; font-weight: 800; letter-spacing: -0.02em; }
  .loader-logo span { color: var(--orange); }

  .loader-bar {
    width: 120px;
    height: 2px;
    background: var(--bg3);
    border-radius: 1px;
    overflow: hidden;
  }

  .loader-bar::after {
    content: '';
    display: block;
    height: 100%;
    background: var(--orange);
    border-radius: 1px;
    animation: loadBar 1.5s ease-in-out infinite;
  }

  @keyframes loadBar {
    0%   { width: 0%; margin-left: 0%; }
    50%  { width: 60%; margin-left: 20%; }
    100% { width: 0%; margin-left: 100%; }
  }

  .no-routes {
    padding: 32px 16px;
    text-align: center;
    color: var(--text-dim);
    font-size: 13px;
    line-height: 1.6;
  }

  .no-routes strong { display: block; font-size: 20px; margin-bottom: 8px; color: rgba(255,255,255,0.2); }
</style>
</head>
<body>

<!-- Loading screen -->
<div id="loading">
  <div class="loader-logo">Euro<span>Ticket</span></div>
  <div class="loader-bar"></div>
</div>

<!-- Logo -->
<div id="logo">
  <div class="logo-icon">ğŸš†</div>
  <div class="logo-text">Euro<span>Ticket</span></div>
</div>

<!-- Status hint -->
<div id="status-hint">Ğ’Ğ¸Ğ±ĞµÑ€Ñ–Ñ‚ÑŒ ÑÑ‚Ğ°Ğ½Ñ†Ñ–Ñ Ğ²Ñ–Ğ´Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ</div>

<!-- Map -->
<div id="map"></div>

<!-- Sidebar with routes -->
<div id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-label">ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ¸</div>
    <div class="sidebar-title" id="sidebar-title">â€”</div>
    <div class="route-count" id="route-count"></div>
  </div>
  <div id="routes-list"></div>
</div>

<!-- Clear button -->
<button id="clear-btn" onclick="clearSelection()">âœ• Ğ¡ĞºĞ¸Ğ½ÑƒÑ‚Ğ¸ Ğ²Ğ¸Ğ±Ñ–Ñ€</button>

<!-- Search bar -->
<div id="search-bar">
  <div class="search-field" id="from-field">
    <label>Ğ—Ğ²Ñ–Ğ´ĞºĞ¸</label>
    <input type="text" id="from-input" placeholder="Ğ¡Ñ‚Ğ°Ğ½Ñ†Ñ–Ñ Ğ²Ñ–Ğ´Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ" autocomplete="off">
    <div class="autocomplete-dropdown" id="from-dropdown"></div>
  </div>
  <div class="divider-v"></div>
  <div class="search-field" id="to-field">
    <label>ĞšÑƒĞ´Ğ¸</label>
    <input type="text" id="to-input" placeholder="Ğ¡Ñ‚Ğ°Ğ½Ñ†Ñ–Ñ Ğ¿Ñ€Ğ¸Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ½Ñ" autocomplete="off">
    <div class="autocomplete-dropdown" id="to-dropdown"></div>
  </div>
  <button class="swap-btn" onclick="swapStations()" title="ĞŸĞ¾Ğ¼Ñ–Ğ½ÑÑ‚Ğ¸ Ğ¼Ñ–ÑÑ†ÑĞ¼Ğ¸">â‡„</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let allStations = [];
let markers = {};
let selectedFrom = null;
let selectedTo = null;
let reachableSet = new Set();
let routePolylines = [];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Map Init
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const map = L.map('map', {
  center: [52.0, 19.5],
  zoom: 6,
  zoomControl: false,
  attributionControl: true
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Marker creation
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function createMarkerIcon(platforms, state) {
  // state: 'normal' | 'selected' | 'reachable' | 'dimmed'
  const base = 8 + Math.min(platforms - 1, 5) * 2.5;
  const colors = {
    normal:    { fill: '#E8722A', stroke: '#7A3A10', glow: 'rgba(232,114,42,0.3)' },
    selected:  { fill: '#F4A261', stroke: '#E8722A', glow: 'rgba(244,162,97,0.6)' },
    reachable: { fill: '#E8722A', stroke: '#7A3A10', glow: 'rgba(232,114,42,0.35)' },
    dimmed:    { fill: '#3A3A3A', stroke: '#222',    glow: 'none' }
  };
  const c = colors[state] || colors.normal;
  const r = base;
  const svgSize = (r + 6) * 2;
  const cx = svgSize / 2;

  const svg = `<svg width="${svgSize}" height="${svgSize}" viewBox="0 0 ${svgSize} ${svgSize}" xmlns="http://www.w3.org/2000/svg">
    <circle cx="${cx}" cy="${cx}" r="${r + 4}" fill="${c.glow}" />
    <circle cx="${cx}" cy="${cx}" r="${r}" fill="${c.fill}" stroke="${c.stroke}" stroke-width="2"/>
    <circle cx="${cx}" cy="${cx}" r="${r * 0.45}" fill="rgba(255,255,255,0.9)"/>
  </svg>`;

  return L.divIcon({
    html: svg,
    className: '',
    iconSize: [svgSize, svgSize],
    iconAnchor: [svgSize / 2, svgSize / 2]
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Load stations
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadStations() {
  const res = await fetch('/api/stations');
  allStations = await res.json();

  allStations.forEach(s => {
    const m = L.marker([s.lat, s.lon], {
      icon: createMarkerIcon(s.platforms, 'normal'),
      title: s.name
    }).addTo(map);

    // Tooltip (station name label)
    m.bindTooltip(s.name, {
      permanent: false,
      direction: 'top',
      className: 'station-label',
      offset: [0, -8]
    });

    m.on('click', () => onMarkerClick(s));
    markers[s.name] = { marker: m, data: s };
  });

  document.getElementById('loading').classList.add('fade-out');
  setTimeout(() => document.getElementById('loading').remove(), 600);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Selection logic
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function onMarkerClick(station) {
  if (!selectedFrom) {
    await selectFrom(station.name);
  } else if (!selectedTo && station.name !== selectedFrom) {
    if (reachableSet.has(station.name)) {
      await selectTo(station.name);
    }
  }
}

async function selectFrom(name) {
  selectedFrom = name;
  selectedTo = null;
  document.getElementById('from-input').value = name;
  document.getElementById('to-input').value = '';
  document.getElementById('status-hint').textContent = 'Ğ’Ğ¸Ğ±ĞµÑ€Ñ–Ñ‚ÑŒ ÑÑ‚Ğ°Ğ½Ñ†Ñ–Ñ Ğ¿Ñ€Ğ¸Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ½Ñ';
  document.getElementById('clear-btn').classList.add('visible');
  closeSidebar();
  clearPolylines();

  // Fetch reachable
  const res = await fetch(`/api/reachable?from=${encodeURIComponent(name)}`);
  const reachable = await res.json();
  reachableSet = new Set(reachable);

  updateAllMarkers();
}

async function selectTo(name) {
  selectedTo = name;
  document.getElementById('to-input').value = name;
  document.getElementById('status-hint').textContent = 'Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ–Ğ²â€¦';
  await fetchAndShowRoutes();
}

function updateAllMarkers() {
  Object.entries(markers).forEach(([name, obj]) => {
    let state;
    if (name === selectedFrom) state = 'selected';
    else if (name === selectedTo) state = 'selected';
    else if (selectedFrom && !selectedTo) {
      state = reachableSet.has(name) ? 'reachable' : 'dimmed';
    } else {
      state = 'normal';
    }
    obj.marker.setIcon(createMarkerIcon(obj.data.platforms, state));
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Routes
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchAndShowRoutes() {
  const res = await fetch(`/api/routes?from=${encodeURIComponent(selectedFrom)}&to=${encodeURIComponent(selectedTo)}`);
  const routes = await res.json();

  clearPolylines();
  updateAllMarkers();

  // Draw route line on map
  if (routes.length > 0) {
    const route = routes[0].route;
    const latlngs = route.map(stop => {
      const s = markers[stop.station];
      return s ? [s.data.lat, s.data.lon] : null;
    }).filter(Boolean);

    if (latlngs.length > 1) {
      const poly = L.polyline(latlngs, {
        color: '#E8722A',
        weight: 3,
        opacity: 0.7,
        dashArray: '6 4'
      }).addTo(map);
      routePolylines.push(poly);
      map.fitBounds(poly.getBounds(), { padding: [60, 60] });
    }
  }

  renderRoutes(routes);
  openSidebar();
  document.getElementById('status-hint').textContent = `${routes.length} Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚(Ñ–Ğ²) Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾`;
}

function clearPolylines() {
  routePolylines.forEach(p => map.removeLayer(p));
  routePolylines = [];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Render routes in sidebar
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRoutes(routes) {
  const title = document.getElementById('sidebar-title');
  const count = document.getElementById('route-count');
  const list  = document.getElementById('routes-list');

  title.textContent = `${selectedFrom} â†’ ${selectedTo}`;
  count.textContent = `${routes.length} Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚(Ñ–Ğ²)`;
  list.innerHTML = '';

  if (routes.length === 0) {
    list.innerHTML = '<div class="no-routes"><strong>â˜</strong>ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ–Ğ² Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ Ğ¼Ñ–Ğ¶ Ñ†Ğ¸Ğ¼Ğ¸ ÑÑ‚Ğ°Ğ½Ñ†Ñ–ÑĞ¼Ğ¸.</div>';
    return;
  }

  routes.forEach((r, i) => {
    const card = document.createElement('div');
    card.className = 'route-card';
    card.style.animationDelay = `${i * 0.06}s`;

    const amenities = [
      { key: 'has_wifi',          icon: 'ğŸ“¶', label: 'Wi-Fi' },
      { key: 'has_air_con',       icon: 'â„ï¸',  label: 'ĞšĞ¾Ğ½Ğ´Ğ¸Ñ†Ñ–Ğ¾Ğ½ĞµÑ€' },
      { key: 'is_accessible',     icon: 'â™¿', label: 'Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ–ÑÑ‚ÑŒ' },
      { key: 'has_bicycle_holder',icon: 'ğŸš²', label: 'Ğ’ĞµĞ»Ğ¾Ñ‚Ñ€Ğ¸Ğ¼Ğ°Ñ‡' },
      { key: 'has_restaurant',    icon: 'ğŸ½ï¸', label: 'Ğ ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½' }
    ];

    const amenitiesHtml = amenities.map(a =>
      `<div class="amenity ${r[a.key] ? 'active' : ''}" title="${a.label}">${a.icon}</div>`
    ).join('');

    const stopsHtml = r.route.map((stop, si) => {
      const isLast = si === r.route.length - 1;
      const time = stop.departure || stop.arrival || '';
      return `
        <div class="stop-row">
          <div class="stop-timeline">
            <div class="stop-dot"></div>
            ${!isLast ? '<div class="stop-line"></div>' : ''}
          </div>
          <div class="stop-content">
            <div class="stop-station">${stop.station}</div>
            ${time ? `<div class="stop-times">${stop.arrival ? 'â†’ ' + stop.arrival : ''} ${stop.departure ? 'â† ' + stop.departure : ''}</div>` : ''}
          </div>
        </div>`;
    }).join('');

    card.innerHTML = `
      <div class="route-card-header">
        <div>
          <div class="train-number">${r.train_number}</div>
          ${r.train_name ? `<div class="train-name">${r.train_name}</div>` : ''}
        </div>
        <div class="amenities">${amenitiesHtml}</div>
      </div>
      <div class="route-stops">${stopsHtml}</div>`;

    list.appendChild(card);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Sidebar
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSidebar()  { document.getElementById('sidebar').classList.add('open'); }
function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Clear
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function clearSelection() {
  selectedFrom = null;
  selectedTo = null;
  reachableSet = new Set();
  document.getElementById('from-input').value = '';
  document.getElementById('to-input').value = '';
  document.getElementById('status-hint').textContent = 'Ğ’Ğ¸Ğ±ĞµÑ€Ñ–Ñ‚ÑŒ ÑÑ‚Ğ°Ğ½Ñ†Ñ–Ñ Ğ²Ñ–Ğ´Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ';
  document.getElementById('clear-btn').classList.remove('visible');
  clearPolylines();
  closeSidebar();
  updateAllMarkers();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Swap
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function swapStations() {
  if (!selectedFrom && !selectedTo) return;
  const tmp = selectedFrom;
  clearSelection();
  if (tmp) setTimeout(() => selectFrom(tmp), 50);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Autocomplete
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupAutocomplete(inputId, dropdownId, onSelect) {
  const input = document.getElementById(inputId);
  const dropdown = document.getElementById(dropdownId);

  input.addEventListener('input', () => {
    const q = input.value.toLowerCase().trim();
    if (!q) { dropdown.classList.remove('show'); return; }
    const matches = allStations
      .map(s => s.name)
      .filter(n => n.toLowerCase().includes(q))
      .slice(0, 8);

    dropdown.innerHTML = matches.map(n =>
      `<div class="autocomplete-item" data-name="${n}">${n}</div>`
    ).join('');
    dropdown.classList.toggle('show', matches.length > 0);
  });

  dropdown.addEventListener('click', e => {
    const item = e.target.closest('.autocomplete-item');
    if (!item) return;
    const name = item.dataset.name;
    input.value = name;
    dropdown.classList.remove('show');
    onSelect(name);
  });

  document.addEventListener('click', e => {
    if (!input.contains(e.target) && !dropdown.contains(e.target)) {
      dropdown.classList.remove('show');
    }
  });
}

setupAutocomplete('from-input', 'from-dropdown', async (name) => {
  await selectFrom(name);
});

setupAutocomplete('to-input', 'to-dropdown', async (name) => {
  if (selectedFrom && reachableSet.has(name)) {
    await selectTo(name);
  } else if (!selectedFrom) {
    await selectFrom(name);
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Init
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
loadStations();
</script>
</body>
</html>